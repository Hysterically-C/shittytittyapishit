local replicatedstorage = game:GetService("ReplicatedStorage")

local library = loadstring(game:HttpGet('https://raw.githubusercontent.com/ovoch228/depthsoimgui/refs/heads/main/library'))()
local bytenet = require(replicatedstorage:WaitForChild("Teawork"):WaitForChild("Shared"):WaitForChild("Services"):WaitForChild("ByteNetworking"))

local api = {}
local FAST_WAIT = 0.03

if game.PlaceId ~= 124069847780670 then return api end

local towers = bytenet.Towers
local mapinfo = replicatedstorage.RoundInfo
local roundresultui = game:GetService("Players").LocalPlayer.PlayerGui.GameUI.RoundResult
local env = getgenv()

env.totalplacedtowers = 0
env.firsttower = env.firsttower or 1
env.isroundover = false

roundresultui:GetPropertyChangedSignal("Visible"):Connect(function()
	env.isroundover = roundresultui.Visible
end)

function api:Place(tower, position)
	env.totalplacedtowers += 1
	local attempt = 0

	while not env.isroundover do
		attempt += 1
		local ok, res = pcall(function()
			return towers.PlaceTower.invoke({
				Position = position,
				Rotation = 0,
				TowerID = tower
			})
		end)

		if ok and (type(res) ~= "table" or res.Success ~= false) then
			updatelog("Placed " .. tower .. " (attempt " .. attempt .. ")")
			return
		end

		updatelog("Place failed " .. tower .. " (attempt " .. attempt .. ")")
		task.wait(FAST_WAIT)
	end
end

-- ðŸ”’ HARD GUARANTEED UPGRADE
function api:Upgrade(towerIndex, targetLevel)
	local realindex = env.firsttower + (towerIndex - 1)
	local currentLevel = 0
	local attempt = 0

	while not env.isroundover do
		attempt += 1

		local ok, res = pcall(function()
			return towers.UpgradeTower.invoke(realindex)
		end)

		if ok and type(res) == "table" then
			if res.Success then
				if typeof(res.Level) == "number" then
					currentLevel = res.Level
					updatelog(
						"Upgrade tower " .. towerIndex ..
						" â†’ level " .. currentLevel ..
						" / " .. targetLevel ..
						" (attempt " .. attempt .. ")"
					)

					if currentLevel >= targetLevel then
						updatelog(
							"Upgrade COMPLETE tower " ..
							towerIndex .. " reached level " .. currentLevel
						)
						return
					end
				else
					updatelog(
						"Upgrade success but no level yet (attempt " ..
						attempt .. "), retrying"
					)
				end
			else
				updatelog(
					"Upgrade failed: " ..
					tostring(res.FailReason) ..
					" (attempt " .. attempt .. ")"
				)
			end
		else
			updatelog("Upgrade invoke error (attempt " .. attempt .. ")")
		end

		task.wait(FAST_WAIT)
	end
end

function api:SetTarget(towerIndex, target)
	local realindex = env.firsttower + (towerIndex - 1)
	local attempt = 0

	while not env.isroundover do
		attempt += 1
		local ok = pcall(function()
			towers.SetTargetMode.send({
				UID = realindex,
				TargetMode = target
			})
		end)

		if ok then
			updatelog("Target set tower " .. towerIndex .. " â†’ " .. target)
			return
		end

		task.wait(FAST_WAIT)
	end
end

function api:Sell(towerIndex)
	local realindex = env.firsttower + (towerIndex - 1)
	local attempt = 0

	while not env.isroundover do
		attempt += 1
		local ok = pcall(function()
			towers.SellTower.invoke(realindex)
		end)

		if ok then
			updatelog("Sold tower " .. towerIndex)
			return
		end

		task.wait(FAST_WAIT)
	end
end

function api:PlayAgain()
	while not env.isroundover do task.wait(FAST_WAIT) end
	env.firsttower = env.totalplacedtowers + 1
	task.wait(0.5
